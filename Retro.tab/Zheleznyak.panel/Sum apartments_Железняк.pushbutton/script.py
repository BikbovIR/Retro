# -*- coding: utf-8 -*-
__title__ = "–ö–≤–∞—Ä—Ç–∏—Ä–æ–≥—Ä–∞—Ñ–∏—è –ñ–µ–ª–µ–∑–Ω—è–∫ 2.0"
__doc__ = """
Date = 25.11.2025
_________________________________________________________________
–î–æ–±–∞–≤–ª–µ–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–µ–π –∫–≤–∞—Ä—Ç–∏—Ä

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –∑–∞–¥–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: 
ADSK_–¢–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è
ADSK_–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã


–ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
ADSK_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã
ADSK_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –æ–±—â–∞—è
ADSK_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –∂–∏–ª–∞—è
ADSK_–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
ADSK_–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏
ADSK_–ü–ª–æ—â–∞–¥—å —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
ADSK_–ò–Ω–¥–µ–∫—Å –ø–æ–º–µ—â–µ–Ω–∏—è
RETRO_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –æ–±—â–∞—è –±–µ–∑ –∫–æ—ç—Ñ
RETRO_–ê–†_–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏

'RETRO_–ü–ª–æ—â–∞–¥—å –ø–æ–º–µ—â–µ–Ω–∏—è' –¥–ª—è –≤—Å–µ—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –≤ –ø—Ä–æ–µ–∫—Ç–µ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å,
–Ω–æ –¥–ª—è –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä –ø–µ—Ä–µ–º–Ω–æ–∂–∞–µ—Ç—Å—è Retro –∏ ADSK –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
_________________________________________________________________
–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–µ–π –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π

–¢–∏–ø—ã –ø–æ–º–µ—â–µ–Ω–∏–π:
"1" - –∂–∏–ª–æ–µ   –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç - 1
"2" - –Ω–µ–∂–∏–ª–æ–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç - 1
"3" - –ª–æ–¥–∂–∏—è  –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç - 0.5
"4" - –±–∞–ª–∫–æ–Ω  –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç - 0.3
"5" - –æ–±—â–µ–µ   –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç - 1
_________________________________________________________________
Author: Bikbov Ilnur"""

# ‚ï¶‚ïî‚ï¶‚ïó‚ïî‚ïê‚ïó‚ïî‚ïê‚ïó‚ï¶‚ïê‚ïó‚ïî‚ï¶‚ïó‚ïî‚ïê‚ïó
# ‚ïë‚ïë‚ïë‚ïë‚ï†‚ïê‚ïù‚ïë ‚ïë‚ï†‚ï¶‚ïù ‚ïë ‚ïö‚ïê‚ïó
# ‚ï©‚ï© ‚ï©‚ï©  ‚ïö‚ïê‚ïù‚ï©‚ïö‚ïê ‚ï© ‚ïö‚ïê‚ïù IMPORTS
# ==================================================
from Autodesk.Revit.DB import *
from pyrevit import forms

import sys
from decimal import Decimal, ROUND_HALF_UP

# ‚ï¶  ‚ï¶‚ïî‚ïê‚ïó‚ï¶‚ïê‚ïó‚ï¶‚ïî‚ïê‚ïó‚ïî‚ïó ‚ï¶  ‚ïî‚ïê‚ïó‚ïî‚ïê‚ïó
# ‚ïö‚ïó‚ïî‚ïù‚ï†‚ïê‚ï£‚ï†‚ï¶‚ïù‚ïë‚ï†‚ïê‚ï£‚ï†‚ï©‚ïó‚ïë  ‚ïë‚ï£ ‚ïö‚ïê‚ïó
#  ‚ïö‚ïù ‚ï© ‚ï©‚ï©‚ïö‚ïê‚ï©‚ï© ‚ï©‚ïö‚ïê‚ïù‚ï©‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù VARIABLES
# ==================================================
doc   = __revit__.ActiveUIDocument.Document #type: Document
uidoc = __revit__.ActiveUIDocument
app   = __revit__.Application

# Global Variables
p_name_room_sorting     = 'ADSK_–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã'
p_name_room_type        = 'ADSK_–¢–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è'

p_name_LivingRoom               = 'ADSK_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –∂–∏–ª–∞—è'                 #- –°—É–º–º–∞ –∂–∏–ª—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
p_name_ApartmentArea            = 'ADSK_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã'                       #- –°—É–º–º–∞ –æ—Ç–∞–ø–ª–∏–≤–∞–µ–º—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
p_name_TotalArea                = 'ADSK_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –æ–±—â–∞—è'                 #- –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
p_name_NumberOfRooms            = 'ADSK_–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç'                      #- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
p_name_koef                     = 'ADSK_–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏'                    #- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏
p_name_AreaWithKoef             = 'ADSK_–ü–ª–æ—â–∞–¥—å —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º'                #- –ü–ª–æ—â–∞–¥—å –ø–æ–º–µ—â–µ–Ω–∏—è —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
p_name_RoomIndex                = 'ADSK_–ò–Ω–¥–µ–∫—Å –ø–æ–º–µ—â–µ–Ω–∏—è'                       #- –ò–Ω–¥–µ–∫—Å –ø–æ–º–µ—â–µ–Ω–∏—è (–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã+–¢–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è)
p_name_TotalAreaWithoutKoef     = 'RETRO_–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –æ–±—â–∞—è –±–µ–∑ –∫–æ—ç—Ñ'       #- –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –±–µ–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
p_name_RetroArea                = 'RETRO_–ü–ª–æ—â–∞–¥—å –ø–æ–º–µ—â–µ–Ω–∏—è'                     #- –ü–∞—Ä–∞–º–µ—Ç—Ä –ø–ª–æ—â–∞–¥–∏ –µ—Å–ª–∏ –Ω–∞–¥–æ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–ª–æ—â–∞–¥–∏ –≤ —Å–ø–µ–∫–µ
p_name_RetroKoef                = 'RETRO_–ê–†_–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏'                   #- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏ –†–µ—Ç—Ä–æ –¥–ª—è –¥–æ–ø.–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–æ—â–∞–¥–µ–π

koef_balkony = 0.3
koef_loggia  = 0.5
# ‚ïî‚ï¶‚ïó‚ïî‚ïê‚ïó‚ï¶‚ïî‚ïó‚ïî
# ‚ïë‚ïë‚ïë‚ï†‚ïê‚ï£‚ïë‚ïë‚ïë‚ïë
# ‚ï© ‚ï©‚ï© ‚ï©‚ï©‚ïù‚ïö‚ïù MAIN
# ==================================================




# 1. Get All Rooms
all_rooms = FilteredElementCollector(doc).OfCategory(BuiltInCategory.OST_Rooms).ToElements()

# #‚ùó Check the unplaced areas
for room in all_rooms:
    if room.Location == None:
        print(":clown_face: :clown_face: :clown_face: –í –ø—Ä–æ–µ–∫—Ç–µ –∏–º–µ—é—Ç—Å—è –Ω–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ. –£–¥–∞–ª–∏—Ç–µ –∏—Ö –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. :clown_face: :clown_face: :clown_face:")
        sys.exit()
    elif not(room.Area >0) :
        print(":clown_face: :clown_face: :clown_face: –í –ø—Ä–æ–µ–∫—Ç–µ –∏–º–µ—é—Ç—Å—è –∏–∑–ª–∏—à–Ω–∏–µ –∏–ª–∏ –Ω–µ –æ–∫—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–º–µ—â–µ–Ω–∏—è. –£–¥–∞–ª–∏—Ç–µ –∏—Ö –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. :clown_face: :clown_face: :clown_face:")
        sys.exit()

#get extra coefficient
Koef =  forms.ask_for_string(
    default='0.95',
    prompt='–í–≤–µ–¥–∏—Ç–µ RETRO_–ê–†_–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä',
    title='RETRO_–ê–†_–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏'
)
try:
    Retro_Koef = float(Koef)
except:
    forms.alert("–ù–∞–¥–æ –≤–≤–æ–¥–∏—Ç—å —Ü–∏—Ñ—Ä—ã", exitscript=True)

# 2. Sort By Apartment Number
from collections import defaultdict
dict_rooms = defaultdict(list)


for room in all_rooms:
    try:
        apartment_num = room.LookupParameter(p_name_room_sorting).AsString()
        if apartment_num:
            dict_rooms[apartment_num].append(room)
    except:
        forms.alert("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å—á–∏—Ç–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä {}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –Ω–∞–ª–∏—á–∏–µ.".format(p_name_room_sorting), exitscript=True)


t = Transaction(doc, 'Sum Apartments')
t.Start()

#Exta step - Write existed area but rounded
for every_room in all_rooms:
    try:
        room_area_m2            = UnitUtils.ConvertFromInternalUnits(every_room.Area, UnitTypeId.SquareMeters)
        room_decimal            = Decimal(room_area_m2)
        room_area_m2_rounded    = room_decimal.quantize(Decimal("0.01"),rounding=ROUND_HALF_UP)
        room_area_ft            = UnitUtils.ConvertToInternalUnits(room_area_m2_rounded,UnitTypeId.SquareMeters)
        p_RetroArea             = every_room.LookupParameter(p_name_RetroArea)
        p_RetroArea.Set(room_area_ft)


    except:
        forms.alert("–ù–µ –Ω–∞—à–µ–ª—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä 'RETRO_–ü–ª–æ—â–∞–¥—å –ø–æ–º–µ—â–µ–Ω–∏—è'\n–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –±–µ–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞")
        break

room_tables =[]

for apartment_num, rooms in dict_rooms.items():
    sum_LivingRoom_m2           = 0 #- –°—É–º–º–∞ –∂–∏–ª—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
    sum_ApartmentArea_m2        = 0 #- –°—É–º–º–∞ –æ—Ç–∞–ø–ª–∏–≤–∞–µ–º—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
    sum_TotalArea_m2            = 0 #- –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
    NumberOfRooms               = 0 #- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
    sum_TotalAreaWithoutKoef_m2 = 0 #- –°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –±–µ–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞


    # 3. Sum Apartment Area
    for room in rooms:
        room_type                    = room.LookupParameter(p_name_room_type).AsInteger()
        room_area_m2                 = UnitUtils.ConvertFromInternalUnits(room.Area, UnitTypeId.SquareMeters)
        room_decimal                 = Decimal(room_area_m2)
        room_area_m2_rounded         = room_decimal.quantize(Decimal("0.01"),rounding=ROUND_HALF_UP)
        Retro_Koef                   = Decimal(Retro_Koef)
        Room_koef                    = Decimal(koef_loggia if room_type == 3 else (koef_balkony if room_type == 4 else 1))

        AreaWithKoef_m2_decimal      = room_area_m2_rounded*Retro_Koef*Room_koef
        AreaWithKoef_m2              = AreaWithKoef_m2_decimal.quantize(Decimal('0.01'),rounding=ROUND_HALF_UP)
        RoomIndex                    = str(apartment_num) + '_' + str(room_type)
        sum_TotalAreaWithoutKoef_m2 += room_area_m2_rounded
        Retro_area_m2                = room_area_m2_rounded*Retro_Koef


        if room_type == 1:
            # sum_LivingRoom_ft += room.Area
            sum_LivingRoom_m2    += AreaWithKoef_m2
            sum_ApartmentArea_m2 += AreaWithKoef_m2
            sum_TotalArea_m2     += AreaWithKoef_m2
            NumberOfRooms        += 1
        elif room_type == 2:
            # sum_TotalArea_ft += room.Area
            sum_ApartmentArea_m2 += AreaWithKoef_m2
            sum_TotalArea_m2     += AreaWithKoef_m2
        elif room_type == 3:
            # sum_TotalArea_ft   += room.Area
            sum_TotalArea_m2     += AreaWithKoef_m2
        elif room_type == 4:
            # sum_TotalArea_ft   += room.Area
            sum_TotalArea_m2     += AreaWithKoef_m2
        elif room_type == 5:
            # sum_TotalArea_ft   += room.Area
            sum_TotalArea_m2     += AreaWithKoef_m2

        AreaWithKoef_ft = UnitUtils.ConvertToInternalUnits(AreaWithKoef_m2, UnitTypeId.SquareMeters)
        Retro_area_ft   = UnitUtils.ConvertToInternalUnits(Retro_area_m2, UnitTypeId.SquareMeters)
        try:
            p_koef          = room.LookupParameter(p_name_koef)
            p_AreaWithKoef  = room.LookupParameter(p_name_AreaWithKoef)
            p_RoomIndex     = room.LookupParameter(p_name_RoomIndex)
            p_RetroKoef     = room.LookupParameter(p_name_RetroKoef)
            p_RetroArea     = room.LookupParameter(p_name_RetroArea)

            p_koef.Set(float(Room_koef))
            p_AreaWithKoef.Set(AreaWithKoef_ft)
            p_RoomIndex.Set(RoomIndex)
            p_RetroKoef.Set(Koef)
            p_RetroArea.Set(Retro_area_ft)

        except:
            forms.alert("–ù–µ –Ω–∞—à–µ–ª –∫–∞–∫–∏–µ-—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ö –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤", exitscript=True)

    # Converting M2 to FT
    sum_LivingRoom_ft           = UnitUtils.ConvertToInternalUnits(sum_LivingRoom_m2,          UnitTypeId.SquareMeters)
    sum_ApartmentArea_ft        = UnitUtils.ConvertToInternalUnits(sum_ApartmentArea_m2,       UnitTypeId.SquareMeters)
    sum_TotalArea_ft            = UnitUtils.ConvertToInternalUnits(sum_TotalArea_m2,           UnitTypeId.SquareMeters)
    sum_TotalAreaWithoutKoef_ft = UnitUtils.ConvertToInternalUnits(sum_TotalAreaWithoutKoef_m2,UnitTypeId.SquareMeters)

    room_tables.append([apartment_num,NumberOfRooms,sum_LivingRoom_m2,sum_TotalArea_m2,sum_TotalAreaWithoutKoef_m2])

    # 4. Write Results to Output Parameter
    for room in rooms:
        try:
            p_LivingRoom           = room.LookupParameter(p_name_LivingRoom)
            P_ApartmentArea        = room.LookupParameter(p_name_ApartmentArea)
            p_TotalArea            = room.LookupParameter(p_name_TotalArea)
            p_NumberOfRooms        = room.LookupParameter(p_name_NumberOfRooms)
            p_TotalAreaWithoutKoef = room.LookupParameter(p_name_TotalAreaWithoutKoef)


            p_LivingRoom.Set(sum_LivingRoom_ft)
            P_ApartmentArea.Set(sum_ApartmentArea_ft)
            p_TotalArea.Set(sum_TotalArea_ft)
            p_NumberOfRooms.Set(NumberOfRooms)
            p_TotalAreaWithoutKoef.Set(sum_TotalAreaWithoutKoef_ft)


        except:
            forms.alert("–ù–µ –Ω–∞—à–µ–ª –∫–∞–∫–∏–µ-—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ö –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤", exitscript=True)
t.Commit()

# from pyrevit import script
#
# output = script.get_output()
#
# data = [
# ['row1', 'data', 'data', 80 ],
# ['row2', 'data', 'data', 45 ],
# ]
# output.print_table(
# table_data=room_tables,
# title= "Ô∏è–ì–æ—Ç–æ–≤–æ  üëåÔ∏è",
# columns=["–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç", "–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã", "–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã","–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –±–µ–∑ –∫–æ—ç—Ñ"],
# formats=['', '', '', ''],
# last_line_style='color:green;')
